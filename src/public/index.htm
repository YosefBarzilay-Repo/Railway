<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Scenario Builder</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232563eb'%3E%3Cpath d='M12 2c-4 0-8 .5-8 4v9.5C4 17.43 5.12 18.5 6.5 18.5H7l-1 2h2l1-2h6l1 2h2l-1-2h.5c1.38 0 2.5-1.07 2.5-3V6c0-3.5-4-4-8-4zM7.5 14.5c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm9 0c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM18 10H6V6h12v4z'/%3E%3C/svg%3E">
    <link rel="stylesheet" href="../style/styles.css">
</head>
<body>
    <header class="app-header">
        <svg class="logo" width="24" height="24" viewBox="0 0 24 24">
            <path d="M12 2c-4 0-8 .5-8 4v9.5C4 17.43 5.12 18.5 6.5 18.5H7l-1 2h2l1-2h6l1 2h2l-1-2h.5c1.38 0 2.5-1.07 2.5-3V6c0-3.5-4-4-8-4zM7.5 14.5c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm9 0c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM18 10H6V6h12v4z"/>
        </svg>
        <h1>Railway</h1>
        <span class="version">v1.0.0.0</span>
    </header>
    
    <div class="main-container">
        <div class="controls">
            <button id="saveProject" title="Save Test File">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3 1.34 3 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
            </button>
            <button id="openRecent" title="Open Recent Test File">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
            </button>
            <button id="exportCSV" title="Export to CSV">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </button>
            <div class="toolbar-divider"></div>
            <button id="reviewMode" onclick="saveData(); window.location.href='../review_mode.htm'" title="Review Mode">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </button>
        </div>
        <div class="table-container">
            <table id="scenarioTable">
                <thead>
                    <tr>
                        <th style="width: 35px;" data-sort="id">ID</th>
                        <!-- Columns will be generated by JS -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Rows will be generated here -->
                </tbody>
            </table>
        </div>
    </div>
    <div class="filter-dialog" id="filterDialog">
        <h3>Filter by <span id="filterCol"></span></h3>
        <input type="text" id="filterInput" placeholder="Contains text...">
        <div class="filter-actions">
            <button id="applyFilter" title="Apply Filter"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></button>
            <button id="clearFilter" title="Clear Filter"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-8 3.58-8 8s3.58 8 8 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></button>
            <button id="closeFilter" title="Close"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
        </div>
    </div>
    <div id="inputTooltip" class="input-tooltip"></div>
    
    <div id="startupOverlay" class="startup-overlay">
        <div class="startup-dialog">
            <h2>Welcome</h2>
            <p>Start a new test file, continue previous session, or open a saved file.</p>
            <div class="startup-buttons">
                <button id="btnNewFile">New Test File</button>
                <button id="btnContinue">Continue Session</button>
            </div>
            <div id="savedFilesList" style="margin-top: 20px; text-align: left; border-top: 1px solid #eee; padding-top: 10px;">
                <!-- List items will go here -->
            </div>
        </div>
    </div>

    <div id="saveDialog" class="startup-overlay" style="display:none;">
        <div class="startup-dialog">
            <h2>Save Test File</h2>
            <p>Enter a name for your test file.</p>
            <p id="saveLimitMsg" style="font-size: 12px; color: #888; margin-bottom: 10px;"></p>
            <input type="text" id="saveFileName" placeholder="File Name" style="width: 100%; padding: 8px; margin-bottom: 15px; box-sizing: border-box; border: 1px solid #d4d4d4; border-radius: 4px;">
            <div class="startup-buttons">
                <button id="btnCancelSave">Cancel</button>
                <button id="btnConfirmSave">Save</button>
            </div>
        </div>
    </div>

    <script>
        const tableBody = document.getElementById('tableBody');
        const exportBtn = document.getElementById('exportCSV');

        // History Management
        const historyStack = [];
        let historyStep = -1;
        let currentFocusVal = '';

        function recordAction(action) {
            if (historyStep < historyStack.length - 1) {
                historyStack.splice(historyStep + 1);
            }
            historyStack.push(action);
            historyStep++;
        }

        function undo() {
            if (historyStep >= 0) {
                const action = historyStack[historyStep];
                if (action.type === 'edit') {
                    action.cell.value = action.oldValue;
                    const preview = action.cell.previousElementSibling;
                    if (preview && preview.classList.contains('preview-text')) preview.textContent = action.oldValue;
                    flashCell(action.cell);
                } else if (action.type === 'batch') {
                    action.changes.forEach(c => {
                        c.cell.value = c.oldValue;
                        const preview = c.cell.previousElementSibling;
                        if (preview && preview.classList.contains('preview-text')) preview.textContent = c.oldValue;
                        flashCell(c.cell);
                    });
                } else if (action.type === 'add') {
                    action.rows.forEach(r => r.remove());
                }
                historyStep--;
            }
        }

        function redo() {
            if (historyStep < historyStack.length - 1) {
                historyStep++;
                const action = historyStack[historyStep];
                if (action.type === 'edit') {
                    action.cell.value = action.newValue;
                    const preview = action.cell.previousElementSibling;
                    if (preview && preview.classList.contains('preview-text')) preview.textContent = action.newValue;
                    flashCell(action.cell);
                } else if (action.type === 'batch') {
                    action.changes.forEach(c => {
                        c.cell.value = c.newValue;
                        const preview = c.cell.previousElementSibling;
                        if (preview && preview.classList.contains('preview-text')) preview.textContent = c.newValue;
                        flashCell(c.cell);
                    });
                } else if (action.type === 'add') {
                    action.rows.forEach(r => tableBody.appendChild(r));
                }
            }
        }

        function flashCell(cell) {
            cell.classList.remove('cell-updated');
            void cell.offsetWidth;
            cell.classList.add('cell-updated');
        }

        let idCounter = 1;

        // Column Definitions
        let columns = [
            { id: 'title', label: 'Title', custom: false },
            { id: 'section', label: 'Section', custom: false },
            { id: 'precondition', label: 'Precondition', custom: false },
            { id: 'steps', label: 'Steps', custom: false },
            { id: 'expected_results', label: 'Expected Results', custom: false },
            { id: 'type', label: 'Type', custom: false },
            { id: 'gw_mode', label: 'GW Mode', custom: false }
        ];

        // Load columns from storage if available
        const savedColumns = localStorage.getItem('railway_columns');
        if (savedColumns) {
            columns = JSON.parse(savedColumns);
        }

        function renderHeader() {
            const tr = document.querySelector('#scenarioTable thead tr');
            const idTh = tr.firstElementChild; // Keep ID column
            
            // Add button to ID column to allow adding before first column
            idTh.innerHTML = 'ID';
            const addBtnId = document.createElement('button');
            addBtnId.className = 'add-col-btn';
            addBtnId.textContent = '+';
            addBtnId.title = 'Add column after';
            addBtnId.onclick = (e) => {
                e.stopPropagation();
                promptAddColumn(-1);
            };
            idTh.appendChild(addBtnId);

            tr.innerHTML = '';
            tr.appendChild(idTh);

            columns.forEach((col, index) => {
                const th = document.createElement('th');
                th.dataset.sort = col.id;
                
                // Header Content
                const content = document.createElement('div');
                content.className = 'header-content';
                
                const labelSpan = document.createElement('span');
                labelSpan.className = 'header-label';
                labelSpan.textContent = col.label;
                labelSpan.contentEditable = true;
                labelSpan.onclick = (e) => e.stopPropagation();
                labelSpan.onkeydown = (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); labelSpan.blur(); }
                };
                labelSpan.onblur = () => {
                    columns[index].label = labelSpan.textContent;
                    saveData();
                };
                content.appendChild(labelSpan);
                
                if (col.custom) {
                    const delBtn = document.createElement('button');
                    delBtn.className = 'del-col-btn';
                    delBtn.innerHTML = '×';
                    delBtn.title = 'Delete Column';
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteColumn(index);
                    };
                    content.appendChild(delBtn);
                }
                th.appendChild(content);

                // Resizer
                const resizer = document.createElement('div');
                resizer.className = 'resizer';
                th.appendChild(resizer);

                // Filter Btn
                const filterBtn = document.createElement('button');
                filterBtn.className = 'filter-btn';
                filterBtn.dataset.col = col.id;
                filterBtn.innerHTML = '<svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/></svg>';
                th.appendChild(filterBtn);

                // Add Column Btn
                const addBtn = document.createElement('button');
                addBtn.className = 'add-col-btn';
                addBtn.textContent = '+';
                addBtn.title = 'Add column after';
                addBtn.onclick = (e) => {
                    e.stopPropagation();
                    promptAddColumn(index);
                };
                th.appendChild(addBtn);

                tr.appendChild(th);
            });
            
            attachResizers();
        }

        function attachResizers() {
            const ths = document.querySelectorAll('th');
            ths.forEach(th => {
                const resizer = th.querySelector('.resizer');
                if (resizer) initResizer(resizer, th);
            });
        }

        // Function to create a row
        function createRow(data = {}) {
            const row = document.createElement('tr');
            // ID cell
            const idCell = document.createElement('td');
            idCell.className = 'id-cell';
            idCell.appendChild(document.createTextNode(idCounter++));
            
            // Add Row Button
            const addRowBtn = document.createElement('button');
            addRowBtn.className = 'add-row-btn';
            addRowBtn.textContent = '+';
            addRowBtn.title = 'Add row below';
            addRowBtn.onclick = (e) => {
                e.stopPropagation();
                const newRow = createRow();
                row.after(newRow);
                updateRowIds();
                saveData();
            };
            idCell.appendChild(addRowBtn);
            
            row.appendChild(idCell);
            // Dynamic columns
            columns.forEach(col => {
                const cell = document.createElement('td');
                
                const preview = document.createElement('div');
                preview.className = 'preview-text';
                preview.textContent = data[col.id] || '';
                cell.appendChild(preview);

                const textarea = document.createElement('textarea');
                textarea.name = col.id;
                textarea.draggable = true;
                textarea.rows = 1;
                textarea.value = data[col.id] || '';
                cell.appendChild(textarea);
                row.appendChild(cell);
            });
            return row;
        }

        // Initialize Header
        renderHeader();

        // Load data from localStorage or add initial rows
        const savedData = JSON.parse(localStorage.getItem('railway_scenarios') || '[]');
        if (savedData.length > 0) {
            savedData.forEach(d => tableBody.appendChild(createRow(d)));
            updateRowIds(); // Ensure IDs are correct
        } else {
            for (let i = 0; i < 25; i++) {
                tableBody.appendChild(createRow());
            }
        }

        function updateRowIds() {
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            rows.forEach((row, index) => {
                const idCell = row.cells[0];
                let textNode = null;
                for (let i = 0; i < idCell.childNodes.length; i++) {
                    if (idCell.childNodes[i].nodeType === 3) { // Node.TEXT_NODE
                        textNode = idCell.childNodes[i];
                        break;
                    }
                }
                if (textNode) textNode.textContent = index + 1;
                else idCell.insertBefore(document.createTextNode(index + 1), idCell.firstChild);
            });
            idCounter = rows.length + 1;
        }

        // Column Management
        function promptAddColumn(index) {
            const name = "New Column";
            const id = 'col_' + Date.now();
                columns.splice(index + 1, 0, { id, label: name, custom: true });
                renderHeader();
                
                const rows = Array.from(tableBody.querySelectorAll('tr'));
                rows.forEach(row => {
                    const cell = document.createElement('td');
                    
                    const preview = document.createElement('div');
                    preview.className = 'preview-text';
                    cell.appendChild(preview);

                    const textarea = document.createElement('textarea');
                    textarea.name = id;
                    textarea.draggable = true;
                    textarea.rows = 1;
                    cell.appendChild(textarea);
                    // Insert after current index (index + 1 is ID cell, so index + 2 is target)
                    if (index + 2 < row.cells.length) row.insertBefore(cell, row.cells[index + 2]);
                    else row.appendChild(cell);
                });
                saveData();
        }

        function deleteColumn(index) {
            if (confirm('Delete this column?')) {
                columns.splice(index, 1);
                renderHeader();
                const rows = Array.from(tableBody.querySelectorAll('tr'));
                rows.forEach(row => {
                    row.deleteCell(index + 1); // +1 for ID cell
                });
                saveData();
            }
        }

        // Event Delegation for Focus and Change (History)
        const tooltip = document.getElementById('inputTooltip');
        
        function updateTooltip(textarea) {
            if (!textarea) {
                tooltip.style.display = 'none';
                return;
            }
            tooltip.textContent = textarea.value;
            tooltip.style.display = 'block';
            
            const rect = textarea.getBoundingClientRect();
            const tooltipHeight = tooltip.offsetHeight;
            tooltip.style.left = rect.left + 'px';
            tooltip.style.top = (rect.top - tooltipHeight - 5) + 'px';
            tooltip.style.minWidth = rect.width + 'px';
        }

        document.querySelector('.table-container').addEventListener('scroll', () => {
            if (document.activeElement.tagName === 'TEXTAREA') {
                updateTooltip(document.activeElement);
            } else {
                tooltip.style.display = 'none';
            }
        });

        tableBody.addEventListener('focusin', (e) => {
            if (e.target.tagName === 'TEXTAREA') {
                currentFocusVal = e.target.value;
                updateTooltip(e.target);
            }
        });

        tableBody.addEventListener('input', (e) => {
            if (e.target.tagName === 'TEXTAREA') {
                updateTooltip(e.target);
                const preview = e.target.previousElementSibling;
                if (preview && preview.classList.contains('preview-text')) {
                    preview.textContent = e.target.value;
                }
            }
        });

        tableBody.addEventListener('focusout', (e) => {
            if (e.target.tagName === 'TEXTAREA') {
                tooltip.style.display = 'none';
            }
        });

        tableBody.addEventListener('change', (e) => {
            if (e.target.tagName === 'TEXTAREA') {
                const newVal = e.target.value;
                if (currentFocusVal !== newVal) {
                    recordAction({
                        type: 'edit',
                        cell: e.target,
                        oldValue: currentFocusVal,
                        newValue: newVal
                    });
                    currentFocusVal = newVal;
                }
            }
        });

        // Key navigation
        tableBody.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'TEXTAREA') {
                const cell = e.target.closest('td');
                const row = cell.parentElement;
                const colIndex = cell.cellIndex;

                if (e.key === 'ArrowUp') {
                    const prevRow = row.previousElementSibling;
                    if (prevRow && prevRow.cells[colIndex]) {
                        if (e.target.selectionStart === 0) {
                            e.preventDefault();
                            const target = prevRow.cells[colIndex].querySelector('textarea');
                            if (target) target.focus();
                        }
                    }
                } else if (e.key === 'ArrowDown') {
                    const nextRow = row.nextElementSibling;
                    if (nextRow && nextRow.cells[colIndex]) {
                        if (e.target.selectionStart === e.target.value.length) {
                            e.preventDefault();
                            const target = nextRow.cells[colIndex].querySelector('textarea');
                            if (target) target.focus();
                        }
                    }
                } else if (e.key === 'ArrowLeft') {
                    if (e.target.selectionStart === 0 && e.target.selectionEnd === 0) {
                        e.preventDefault();
                        const prevCell = cell.previousElementSibling;
                        if (prevCell && prevCell.querySelector('textarea')) {
                            prevCell.querySelector('textarea').focus();
                        }
                    }
                } else if (e.key === 'ArrowRight') {
                    if (e.target.selectionStart === e.target.value.length) {
                        e.preventDefault();
                        const nextCell = cell.nextElementSibling;
                        if (nextCell && nextCell.querySelector('textarea')) {
                            nextCell.querySelector('textarea').focus();
                        }
                    }
                }
            }
            // Undo/Redo Shortcuts
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z' && !e.shiftKey) {
                if (e.target.tagName === 'TEXTAREA' && e.target.value !== currentFocusVal) {
                    return; // Let native undo handle text changes in progress
                }
                e.preventDefault();
                undo();
            }
            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key.toLowerCase() === 'z'))) {
                e.preventDefault();
                redo();
            }
        });

        // Sorting
        let currentSort = { col: null, dir: 'asc' };
        document.querySelector('thead').addEventListener('click', (e) => {
            const th = e.target.closest('th');
            if (!th || e.target.classList.contains('filter-btn') || e.target.closest('.filter-btn') || e.target.classList.contains('resizer')) return;
            
            const col = th.dataset.sort;
            if (!col) return;

            let dir = 'asc';
            if (currentSort.col === col) {
                if (currentSort.dir === 'asc') dir = 'desc';
                else if (currentSort.dir === 'desc') dir = 'default';
            }

            if (dir === 'default') {
                currentSort = { col: null, dir: 'asc' };
                document.querySelectorAll('th').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
                // Sort by ID (default order)
                const rows = Array.from(tableBody.querySelectorAll('tr'));
                rows.sort((a, b) => parseInt(a.cells[0].textContent) - parseInt(b.cells[0].textContent));
                rows.forEach(r => tableBody.appendChild(r));
                return;
            }

            currentSort = { col, dir };

            // Update UI
            document.querySelectorAll('th').forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });
            th.classList.add(`sort-${dir}`);

            const rows = Array.from(tableBody.querySelectorAll('tr'));
            rows.sort((a, b) => {
                const aVal = col === 'id' ? a.cells[0].textContent : (a.querySelector(`textarea[name="${col}"]`)?.value || '');
                const bVal = col === 'id' ? b.cells[0].textContent : (b.querySelector(`textarea[name="${col}"]`)?.value || '');
                return dir === 'asc' ? aVal.localeCompare(bVal, undefined, {numeric: true}) : bVal.localeCompare(aVal, undefined, {numeric: true});
            });

            rows.forEach(r => tableBody.appendChild(r));
        });

        // Resizable columns
        function initResizer(resizer, th) {
            let startX, startWidth;
                resizer.addEventListener('mousedown', (e) => {
                    startX = e.clientX;
                    startWidth = th.offsetWidth;
                    document.addEventListener('mousemove', resize);
                    document.addEventListener('mouseup', stopResize);
                });
                function resize(e) {
                    const newWidth = startWidth + (e.clientX - startX);
                    th.style.width = newWidth + 'px';
                }
                function stopResize() {
                    document.removeEventListener('mousemove', resize);
                    document.removeEventListener('mouseup', stopResize);
                }
        }

        // Filter functionality
        const filterDialog = document.getElementById('filterDialog');
        const filterInput = document.getElementById('filterInput');
        const applyFilter = document.getElementById('applyFilter');
        const clearFilter = document.getElementById('clearFilter');
        const closeFilter = document.getElementById('closeFilter');
        const filterColSpan = document.getElementById('filterCol');
        let currentFilterCol = '';

        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.filter-btn');
            if (btn) {
                currentFilterCol = btn.dataset.col;
                filterColSpan.textContent = currentFilterCol;
                
                // Position popup relative to button
                const rect = btn.getBoundingClientRect();
                filterDialog.style.top = (rect.bottom + 5) + 'px';
                
                // Align right edge of dialog with right edge of button
                // Dialog width is approx 226px (200 width + 24 padding + 2 border)
                let leftPos = rect.right - 226;
                if (leftPos < 10) leftPos = 10; // Prevent going off screen left
                filterDialog.style.left = leftPos + 'px';

                filterDialog.style.display = 'block';
                filterInput.focus();
            }
        });

        applyFilter.addEventListener('click', () => {
            const filterText = filterInput.value.toLowerCase();
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const textarea = row.querySelector(`textarea[name="${currentFilterCol}"]`);
                if (textarea) {
                    const visible = textarea.value.toLowerCase().includes(filterText);
                    row.style.display = visible ? '' : 'none';
                }
            });
            
            // Update button state
            const btn = document.querySelector(`.filter-btn[data-col="${currentFilterCol}"]`);
            if (btn) btn.classList.add('filter-active');
            
            filterDialog.style.display = 'none';
        });

        clearFilter.addEventListener('click', () => {
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                row.style.display = '';
            });
            filterInput.value = '';
            
            // Clear button state
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('filter-active'));
            
            filterDialog.style.display = 'none';
        });

        closeFilter.addEventListener('click', () => {
            filterDialog.style.display = 'none';
        });

        // Drag and drop functionality to fill between
        tableBody.addEventListener('dragstart', (e) => {
            if (e.target.tagName === 'TEXTAREA') {
                e.dataTransfer.setData('text/plain', e.target.value);
                e.dataTransfer.setData('name', e.target.name);
                const rows = Array.from(tableBody.querySelectorAll('tr'));
                e.dataTransfer.setData('startIndex', rows.indexOf(e.target.closest('tr')));
                e.target.classList.add('drag-source');
            }
        });

        tableBody.addEventListener('dragover', (e) => {
            if (e.target.tagName === 'TEXTAREA') {
                e.preventDefault();
            }
        });

        tableBody.addEventListener('drop', (e) => {
            if (e.target.tagName === 'TEXTAREA') {
                // Remove source highlight
                const source = document.querySelector('.drag-source');
                if (source) source.classList.remove('drag-source');

                const draggedValue = e.dataTransfer.getData('text/plain');
                const draggedName = e.dataTransfer.getData('name');
                const startIndex = parseInt(e.dataTransfer.getData('startIndex'));
                if (e.target.name === draggedName) {
                    const rows = Array.from(tableBody.querySelectorAll('tr'));
                    const endIndex = rows.indexOf(e.target.closest('tr'));
                    const minIndex = Math.min(startIndex, endIndex);
                    const maxIndex = Math.max(startIndex, endIndex);
                    
                    const changes = [];
                    for (let i = minIndex; i <= maxIndex; i++) {
                        const textarea = rows[i].querySelector(`textarea[name="${draggedName}"]`);
                        if (textarea) {
                            changes.push({ cell: textarea, oldValue: textarea.value, newValue: draggedValue });
                            textarea.value = draggedValue;
                            const preview = textarea.previousElementSibling;
                            if (preview && preview.classList.contains('preview-text')) preview.textContent = draggedValue;
                            // Animation
                            flashCell(textarea);
                        }
                    }
                    if (changes.length > 0) {
                        recordAction({ type: 'batch', changes: changes });
                    }
                }
            }
        });
        
        // Clean up drag source if drag ends without drop
        tableBody.addEventListener('dragend', (e) => {
             if (e.target.classList.contains('drag-source')) {
                 e.target.classList.remove('drag-source');
             }
        });

        function saveData() {
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            const data = rows.map(row => {
                const rowData = {};
                columns.forEach(col => {
                    const textarea = row.querySelector(`textarea[name="${col.id}"]`);
                    if (textarea) {
                        rowData[col.id] = textarea.value;
                    }
                });
                return rowData;
            });
            localStorage.setItem('railway_scenarios', JSON.stringify(data));
            localStorage.setItem('railway_columns', JSON.stringify(columns));
        }

        // Export to CSV
        exportBtn.addEventListener('click', () => {
            const rows = tableBody.querySelectorAll('tr');
            let csvContent = 'ID,' + columns.map(c => c.label).join(',') + '\n';
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const values = Array.from(cells).map(cell => {
                    if (cell.querySelector('textarea')) {
                        return `"${cell.querySelector('textarea').value.replace(/"/g, '""')}"`;
                    } else {
                        let text = "";
                        cell.childNodes.forEach(n => {
                            if (n.nodeType === 3) text += n.textContent;
                        });
                        return `"${text.trim().replace(/"/g, '""')}"`;
                    }
                });
                csvContent += values.join(',') + '\n';
            });
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'scenarios.csv';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Startup Dialog Logic
        const startupOverlay = document.getElementById('startupOverlay');
        const btnNewFile = document.getElementById('btnNewFile');
        const btnContinue = document.getElementById('btnContinue');

        if (sessionStorage.getItem('railway_session_active')) {
            startupOverlay.style.display = 'none';
        }

        btnContinue.addEventListener('click', () => {
            sessionStorage.setItem('railway_session_active', 'true');
            startupOverlay.style.display = 'none';
        });

        btnNewFile.addEventListener('click', () => {
            // Reset Columns to default
            columns = [
                { id: 'title', label: 'Title', custom: false },
                { id: 'section', label: 'Section', custom: false },
                { id: 'precondition', label: 'Precondition', custom: false },
                { id: 'steps', label: 'Steps', custom: false },
                { id: 'expected_results', label: 'Expected Results', custom: false },
                { id: 'type', label: 'Type', custom: false },
                { id: 'gw_mode', label: 'GW Mode', custom: false }
            ];
            
            // Clear Table
            tableBody.innerHTML = '';
            idCounter = 1;
            
            // Re-render
            renderHeader();
            for (let i = 0; i < 25; i++) {
                tableBody.appendChild(createRow());
            }
            
            // Clear Storage by saving the empty state
            saveData();
            sessionStorage.setItem('railway_session_active', 'true');
            
            startupOverlay.style.display = 'none';
        });

        // Open Recent Button
        document.getElementById('openRecent').addEventListener('click', () => {
            renderSavedFilesList();
            startupOverlay.style.display = 'flex';
        });

        // Save Functionality
        const saveBtn = document.getElementById('saveProject');
        const saveDialog = document.getElementById('saveDialog');
        const saveFileName = document.getElementById('saveFileName');
        const btnConfirmSave = document.getElementById('btnConfirmSave');
        const btnCancelSave = document.getElementById('btnCancelSave');
        const saveLimitMsg = document.getElementById('saveLimitMsg');

        saveBtn.addEventListener('click', () => {
            const saves = JSON.parse(localStorage.getItem('railway_saves_index') || '[]');
            saveLimitMsg.textContent = `${saves.length}/5 files used`;
            saveFileName.value = '';
            saveDialog.style.display = 'flex';
            saveFileName.focus();
        });

        btnCancelSave.addEventListener('click', () => {
            saveDialog.style.display = 'none';
        });

        btnConfirmSave.addEventListener('click', () => {
            const name = saveFileName.value.trim();
            if (!name) return alert('Please enter a name');
            
            const saves = JSON.parse(localStorage.getItem('railway_saves_index') || '[]');
            if (!saves.includes(name) && saves.length >= 5) {
                return alert('You have reached the limit of 5 saved files. Please delete one to save a new one.');
            }

            // Prepare data
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            const data = rows.map(row => {
                const rowData = {};
                columns.forEach(col => {
                    const textarea = row.querySelector(`textarea[name="${col.id}"]`);
                    if (textarea) {
                        rowData[col.id] = textarea.value;
                    }
                });
                return rowData;
            });
            
            const fileData = {
                data: data,
                columns: columns,
                timestamp: Date.now()
            };

            try {
                localStorage.setItem(`railway_save_${name}`, JSON.stringify(fileData));
                if (!saves.includes(name)) {
                    saves.push(name);
                    localStorage.setItem('railway_saves_index', JSON.stringify(saves));
                }
                saveDialog.style.display = 'none';
                alert('Test file saved successfully!');
                renderSavedFilesList();
            } catch (e) {
                alert('Error saving file. LocalStorage might be full.');
            }
        });

        function renderSavedFilesList() {
            const listContainer = document.getElementById('savedFilesList');
            const saves = JSON.parse(localStorage.getItem('railway_saves_index') || '[]');
            
            if (saves.length === 0) {
                listContainer.innerHTML = '<p style="font-size:12px; color:#999;">No saved files found.</p>';
                return;
            }

            listContainer.innerHTML = '<h4 style="margin:10px 0; font-size:14px;">Open Saved Test File:</h4>';
            
            saves.forEach(name => {
                const div = document.createElement('div');
                div.className = 'saved-file-item';
                div.innerHTML = `
                    <button class="saved-file-btn" onclick="loadSavedFile('${name}')">${name}</button>
                    <button class="delete-file-btn" title="Delete" onclick="deleteSavedFile('${name}')">×</button>
                `;
                listContainer.appendChild(div);
            });
        }

        window.loadSavedFile = function(name) {
            const fileData = JSON.parse(localStorage.getItem(`railway_save_${name}`));
            if (!fileData) return alert('Error loading file.');
            
            columns = fileData.columns;
            const data = fileData.data;
            
            tableBody.innerHTML = '';
            renderHeader();
            
            if (data && data.length > 0) {
                data.forEach(d => tableBody.appendChild(createRow(d)));
                updateRowIds();
            } else {
                for (let i = 0; i < 25; i++) {
                    tableBody.appendChild(createRow());
                }
            }
            
            saveData(); // Save to current session
            sessionStorage.setItem('railway_session_active', 'true');
            document.getElementById('startupOverlay').style.display = 'none';
        };

        window.deleteSavedFile = function(name) {
            if(confirm(`Delete "${name}"?`)) {
                localStorage.removeItem(`railway_save_${name}`);
                const saves = JSON.parse(localStorage.getItem('railway_saves_index') || '[]');
                const newSaves = saves.filter(s => s !== name);
                localStorage.setItem('railway_saves_index', JSON.stringify(newSaves));
                renderSavedFilesList();
            }
        };

        // Initial render of saved files
        renderSavedFilesList();
    </script>
</body>
</html>